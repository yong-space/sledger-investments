<!DOCTYPE html>
<html lang="en">
<head>
    <title>Portfolio</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />
    <script crossorigin="anonymous" src="https://unpkg.com/@babel/standalone@7.18.8/babel.min.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/@mui/material@5.0.0/umd/material-ui.production.min.js"></script>
    <link crossorigin="anonymous" rel="stylesheet" referrerpolicy="no-referrer" href="https://cdnjs.cloudflare.com/ajax/libs/css-spinning-spinners/1.1.1/load3.css" />
    <link crossorigin="anonymous" rel="stylesheet" referrerpolicy="no-referrer" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
    <link crossorigin="anonymous" rel="stylesheet" referrerpolicy="no-referrer" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <style>
        html, body, #root { height: 100%; margin: 0 }
        #root { background: #121212 }
        table, th, td { border: #555 1px solid }
        th, td { padding: .5rem }
        td.green { color: lightgreen }
        td.red { color: palevioletred }
        th { user-select: none }
        th.select { cursor: pointer }
        input { color-scheme: dark }
        .loading { filter: invert(.5); position: relative; top: 50% }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
    const {
        ThemeProvider,
        createTheme,
        CssBaseline,
        Typography,
        Container,
        Box,
        Table,
        TableBody,
        TableCell,
        TableContainer,
        TableHead,
        TableRow,
        Paper,
        Autocomplete,
        TextField,
        Button,
        Snackbar,
        SnackbarContent,
        MenuItem,
    } = MaterialUI;

    const darkTheme = createTheme({
        palette: { mode: 'dark' },
    });

    const debounce = (func, timeout = 300) => {
        let timer;
        return (...args) => {
            clearTimeout(timer);
            timer = setTimeout(() => { func.apply(this, args); }, timeout);
        };
    };

    const fields = [
        { field: 'symbol', label: "Symbol", sortable: true },
        { field: 'name', label: "Name", sortable: true },
        { field: 'position', label: "Position", sortable: false, decimals: 0 },
        { field: 'price', label: "Price", sortable: false, decimals: 3 },
        { field: 'dividends', label: "Dividends", sortable: true, colour: true, decimals: 2 },
        { field: 'changeToday', label: "Today P&L", sortable: true, colour: true, decimals: 2 },
        { field: 'changeTodayPercentage', label: "Today %", sortable: true, colour: true, decimals: 1 },
        { field: 'profit', label: "P&L", sortable: true, colour: true, decimals: 2 },
        { field: 'profitPercentage', label: "P&L %", sortable: true, colour: true, decimals: 1 },
    ];

    const sort = (data, sortField, sortAsc) => {
        data.sort((a, b) => a[sortField] > b[sortField] ? (sortAsc ? 1 : -1) : (sortAsc ? -1 : 1));
        return data;
    }

    const PortTable = ({ label, data, setData }) => {
        const [ originalData ] = React.useState(data);
        const [ sortField, setSortField ] = React.useState('changeTodayPercentage');
        const [ sortAsc, setSortAsc ] = React.useState(false);
        const sortData = (newSortField) => {
            let order = sortAsc;
            if (newSortField === sortField) {
                order = !order;
                setSortAsc(order);
            } else {
                setSortField(newSortField);
            }
            setData(sort([ ...originalData ], newSortField, order));
        };

        const HeaderTableCell = ({ field, label, sortable }) => {
            return (
                <TableCell
                    key={field}
                    onClick={() => { sortable ? sortData(field) : void(0) }}
                    className={sortable ? 'select' : ''}
                >
                    {label}
                    { (sortField === field) && <Box sx={{ float: 'right'}}>{ sortAsc ? '▲' : '▼' }</Box> }
                </TableCell>
            )
        };

        const formatNumber = (value, decimals) => {
            const parts = value.toFixed(decimals).split(".");
            const whole = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            return (parts[1] && decimals > 0) ? `${whole}.${parts[1]}` : whole;
        };

        const DataTableCell = ({ value, decimals, colour }) => {
            const decimalsDefined = parseInt(decimals) % 1 === 0;
            const formatted = (!decimalsDefined || !value) ? value : formatNumber(value, decimals);
            return (
                <TableCell
                    align={ decimalsDefined ? 'right' : 'left' }
                    className={ colour ? (value > 0 ? 'green' : value < 0 ? 'red' : '') : '' }
                >
                    {formatted}
                </TableCell>
            );
        };

        const SummaryRow = ({ data }) => {
            const amount = data.map(i => i.amount).reduce((a, b) => a += b);
            const changeToday = data.map(i => i['changeToday']).reduce((a, b) => a += b);
            const changeTodayPercentage = changeToday * 100 / amount;
            const profit = data.map(i => i['profit']).reduce((a, b) => a += b);
            const profitPercentage = profit * 100 / amount;

            return (
                <TableRow>
                    <TableCell colSpan={5}></TableCell>
                    <DataTableCell value={changeToday} {...fields[5]} />
                    <DataTableCell value={changeTodayPercentage} {...fields[6]} />
                    <DataTableCell value={profit} {...fields[7]} />
                    <DataTableCell value={profitPercentage} {...fields[8]} />
                </TableRow>
            );
        }

        return (
            <React.Fragment>
                <Typography variant="h5">{label} Portfolio</Typography>
                <TableContainer component={Paper} sx={{ my: "1rem" }}>
                    <Table size="small">
                        <TableHead>
                            <TableRow>
                                { fields.map((field) => <HeaderTableCell {...field} />) }
                            </TableRow>
                        </TableHead>
                        <TableBody>
                            {data.map((row) => (
                                <TableRow key={row.symbol}>
                                    { fields.map((field) => <DataTableCell value={row[field.field]} {...field} />) }
                                </TableRow>
                            ))}
                            <SummaryRow data={data} />
                        </TableBody>
                    </Table>
                </TableContainer>
            </React.Fragment>
        );
    };

    const InstrumentPicker = ({ api, instrument, setInstrument }) => {
        const [options, setOptions] = React.useState([]);
        const search = debounce((event, inputValue) => {
            if (inputValue.trim().length === 0) {
                setOptions([]);
                return;
            }
            api(`/search?query=${inputValue.trim()}`, null, (response) => setOptions(response['Data']));
        }, 300);

        return (
            <Autocomplete
                filterOptions={(x) => x}
                options={options}
                value={instrument}
                onInputChange={search}
                onChange={(event, newValue) => setInstrument(newValue)}
                renderInput={(params) => <TextField fullWidth required {...params} name="instrument" size="small" label="Instrument" />}
                getOptionLabel={(option) => `${option.Symbol} ${option['Description']}`}
            />
        );
    };

    const AddTransactionForm = ({ api, refreshData, setSnackbar }) => {
        const [ txType, setTxType ] = React.useState('Trade');
        const [ instrument, setInstrument ] = React.useState();
        const addTrade = (e) => {
            e.preventDefault();
            const values = Object.values(e.target)
                .filter(field => field.name)
                .reduce((obj,field) => {
                    obj[field.name] = field.type === 'number' ? field.valueAsNumber :
                        field.type === 'date' ? field.valueAsDate.toISOString() : field.value;
                    return obj;
                }, {});
            values.instrument = instrument?.Identifier;
            values.ticker = instrument?.Symbol;

            api('/add-tx', values, () => {
                setSnackbar({ open: true, error: false, msg: 'Trade Added' });
                setInstrument(null);
                e.target.reset();
                refreshData();
            });
        };
        const inputProps = { step: 'any' };

        const FormFields = () => {
            const instrumentAuto = (<InstrumentPicker {...{ api, instrument, setInstrument }} />);
            const instrumentText = (<TextField fullWidth required size="small" name="instrument" label="Instrument" />);
            const price = (<TextField fullWidth required size="small" type="number" inputProps={inputProps} name="price" label="Price" />);
            const quantity = (<TextField fullWidth required size="small" type="number" name="quantity" label="Quantity" />);
            const notional = (<TextField fullWidth required size="small" type="number" inputProps={inputProps} name="notional" label="Notional" />);

            switch (txType) {
                case "Trade": return [ instrumentAuto, price, quantity, notional ];
                case "Deposit": return [ price, notional ];
                case "Dividends": return [ instrumentAuto, notional ];
                case "Fees":
                case "Interest": return [ instrumentText, notional ];
            }
        };

        return (
            <form onSubmit={addTrade}>
                <Box sx={{ display: 'inline-flex', width: '30rem', maxWidth: '100%', flexDirection: "column", gap: '1rem', my: 4 }}>
                    <Typography variant="h5">Add Transaction</Typography>
                    <TextField select name="type" size="small" label="Transaction Type" value={txType} onChange={(e) => setTxType(e.target.value)}>
                        <MenuItem value="Trade">Trade</MenuItem>
                        <MenuItem value="Deposit">Deposit</MenuItem>
                        <MenuItem value="Dividends">Dividends</MenuItem>
                        <MenuItem value="Fees">Fees</MenuItem>
                        <MenuItem value="Interest">Interest</MenuItem>
                    </TextField>
                    <TextField fullWidth required size="small" type="date" name="date" label="Date" defaultValue={new Date().toISOString().substring(0, 10)} />
                    <FormFields />
                    <Button type="submit" variant="contained">Add Transaction</Button>
                </Box>
            </form>
        );
    };

    const App = () => {
        const [ snackbar, setSnackbar ] = React.useState({ open: false });
        const [ usData, setUsData ] = React.useState();
        const [ sgData, setSgData ] = React.useState();
        const snackbarStyle = { color: 'white', fontWeight: 'bold' };

        const api = (uri, body, callback) => {
            const config = body && {
                method: "post",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            };
            fetch(uri, config)
                .then(async (response) => {
                    if (response.ok) {
                        return response?.json() || response?.text();
                    } else {
                        throw await response.json();
                    }
                })
                .then(callback)
                .catch((response) => {
                    const { status, error, message } = response;
                    setSnackbar({ open: true, error: true, msg: `Error ${status||''} ${error||''}: ${message}` });
                    console.log(response);
                });
        }

        const refreshData = () => api('/portfolio', null, (response) => {
            setUsData(sort(response.filter(i => !i.symbol.endsWith(':xses')), 'changeTodayPercentage', false));
            setSgData(sort(response.filter(i => i.symbol.endsWith(':xses')), 'changeTodayPercentage', false));
        });

        React.useEffect(refreshData, []);

        return (
            <ThemeProvider theme={darkTheme}>
                { !(usData && sgData) ? (<div className="loading"></div>) : (
                    <Container>
                        <CssBaseline />
                        <Box sx={{ my: 4 }}>
                            { sgData ? <PortTable label="SG" data={sgData} setData={setSgData} /> : '' }
                            { usData ? <PortTable label="US" data={usData} setData={setUsData} /> : '' }
                        </Box>
                        <AddTransactionForm {...{ api, setSnackbar, refreshData }} />
                    </Container>
                )}
                <Snackbar
                    open={snackbar.open}
                    onClose={() => setSnackbar({ open: false })}
                    autoHideDuration={snackbar.error ? 10000 : 3000}
                >
                    <SnackbarContent style={{ ...snackbarStyle, backgroundColor: snackbar.error ? '#d74545' : '#4e9a51' }} message={snackbar.msg} />
                </Snackbar>
            </ThemeProvider>
        );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
