<!doctype html>
<html lang="en">
    <head>
        <title>Sledger Investments</title>
        <style>
            * { font-family: "JetBrains Mono", serif }
            table { border-collapse: collapse }
            h1 { font-size: 1.5rem }
            table, th, td {
                border: #555 1px solid;
                font-size: .8rem;
            }
            th, td { padding: .5rem }
            td.number { text-align: right }
            .green { color: mediumseagreen }
            .red { color: darkred }
            .select { cursor: pointer }
        </style>
    </head>
    <body>
        <h1>SGX Portfolio</h1>
        <table>
            <tr class="headers"></tr>
            <tbody id="sgx-portfolio"></tbody>
        </table>

        <h1>US Portfolio</h1>
        <table>
            <tr class="headers"></tr>
            <tbody id="us-portfolio"></tbody>
        </table>

        <script>
            const format = (num, decimals = 2) => num.toFixed(decimals).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
            const formatColour = (num, decimals = 2) => `<span class="${num > 0 ? 'green' : num < 0 ? 'red' : ''}">${format(num, decimals)}</span>`;
            const portfolioEntry = ({ symbol, name, position, price, dividends, changeToday, changeTodayPercentage, profit, profitPercentage }) => `
                <tr>
                    <td>${symbol}</td>
                    <td>${name}</td>
                    <td class="number">${format(position, 0)}</td>
                    <td class="number">${format(price, 3)}</td>
                    <td class="number">${formatColour(dividends)}</td>
                    <td class="number">${formatColour(changeToday)}</td>
                    <td class="number">${formatColour(changeTodayPercentage, 1)}</td>
                    <td class="number">${formatColour(profit)}</td>
                    <td class="number">${formatColour(profitPercentage, 1)}</td>
                </tr>
            `;

            const formatRows = (data, sortField) => {
                data.sort((a, b) => a[sortField] > b[sortField] ? 1 : -1);
                const amount = data.map(i => i.amount).reduce((a, b) => a += b);
                const profitToday = data.map(i => i.changeToday).reduce((a, b) => a += b);
                const profitTodayPercent = profitToday * 100 / amount;
                const profit = data.map(i => i.profit).reduce((a, b) => a += b);
                const profitPercent = profit * 100 / amount;

                return data.map(entry => portfolioEntry(entry)).join("") +
                    `<tr>
                        <td colspan="5"></td>
                        <td class="number">${formatColour(profitToday)}</td>
                        <td class="number">${formatColour(profitTodayPercent, 1)}</td>
                        <td class="number">${formatColour(profit)}</td>
                        <td class="number">${formatColour(profitPercent, 1)}</td>
                    </tr>`;
            };

            let storedData;

            const formatData = (sortField) => {
                const sgxData = storedData.filter(i => i.symbol.endsWith(':xses'));
                document.querySelector("#sgx-portfolio").innerHTML = formatRows(sgxData, sortField);

                const usData = storedData.filter(i => !i.symbol.endsWith(':xses'));
                document.querySelector("#us-portfolio").innerHTML = formatRows(usData, sortField);
            };

            const headers = () => `
                <th class="select" onClick="formatData('symbol')">Symbol</th>
                <th class="select" onClick="formatData('name')">Name</th>
                <th>Position</th>
                <th>Price</th>
                <th class="select" onClick="formatData('dividends')">Dividends</th>
                <th class="select" onClick="formatData('changeToday')">Today P&L</th>
                <th class="select" onClick="formatData('changeTodayPercentage')">Today %</th>
                <th class="select" onClick="formatData('profit')">P&L</th>
                <th class="select" onClick="formatData('profitPercentage')">P&L %</th>
            `;

            fetch('/portfolio')
                .then(response => {
                    if (!response.ok) {
                        document.location = '/authorize';
                    }
                    return response.json();
                })
                .then(data => {
                    document.querySelectorAll('.headers').forEach(h => h.innerHTML = headers());
                    storedData = data;
                    formatData('changeTodayPercentage');
                });
        </script>
    </body>
</html>
