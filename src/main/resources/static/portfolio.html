<!DOCTYPE html>
<html lang="en">
<head>
    <title>Portfolio</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />
    <script crossorigin="anonymous" src="https://unpkg.com/@babel/standalone@7.18.8/babel.min.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/@mui/material@5.0.0/umd/material-ui.production.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <style>
        table, th, td { border: #555 1px solid }
        th, td { padding: .5rem }
        td.green { color: lightgreen }
        td.red { color: palevioletred }
        th.select { cursor: pointer }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
    const {
        ThemeProvider,
        createTheme,
        CssBaseline,
        Typography,
        Container,
        Box,
        Table,
        TableBody,
        TableCell,
        TableContainer,
        TableHead,
        TableRow,
        Paper,
        Autocomplete,
        TextField,
        Button,
        Snackbar,
        SnackbarContent
    } = MaterialUI;

    const darkTheme = createTheme({
        palette: { mode: 'dark' },
    });

    const debounce = (func, timeout = 300) => {
        let timer;
        return (...args) => {
            clearTimeout(timer);
            timer = setTimeout(() => { func.apply(this, args); }, timeout);
        };
    };

    const fields = [
        { field: 'symbol', label: "Symbol", sortable: true },
        { field: 'name', label: "Name", sortable: true },
        { field: 'position', label: "Position", sortable: false, decimals: 0 },
        { field: 'price', label: "Price", sortable: false, decimals: 3 },
        { field: 'dividends', label: "Dividends", sortable: true, colour: true, decimals: 2 },
        { field: 'changeToday', label: "Today P&L", sortable: true, colour: true, decimals: 2 },
        { field: 'changeTodayPercentage', label: "Today %", sortable: true, colour: true, decimals: 1 },
        { field: 'profit', label: "P&L", sortable: true, colour: true, decimals: 2 },
        { field: 'profitPercentage', label: "P&L %", sortable: true, colour: true, decimals: 1 },
    ];

    const sort = (data, sortField) => {
        data.sort((a, b) => a[sortField] > b[sortField] ? 1 : -1);
        return data;
    }

    const PortTable = ({ label, data, setData }) => {
        const [ originalData ] = React.useState(data);
        const sortData = (sortField) => setData(sort([ ...originalData ], sortField));

        const HeaderTableCell = ({ field, label, sortable }) => {
            return (
                <TableCell
                    key={field}
                    onClick={() => { sortable ? sortData(field) : void(0) }}
                    className={sortable ? 'select' : ''}
                >
                    {label}
                </TableCell>
            )
        };

        const DataTableCell = ({ value, decimals, colour }) => {
            const formatted = !decimals || !value ? value : value.toFixed(decimals).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
            return (
                <TableCell
                    align={ decimals ? 'right' : 'left' }
                    className={ colour ? (value > 0 ? 'green' : value < 0 ? 'red' : '') : '' }
                >
                    {formatted}
                </TableCell>
            );
        };

        const SummaryRow = ({ data }) => {
            const amount = data.map(i => i.amount).reduce((a, b) => a += b);
            const changeToday = data.map(i => i.changeToday).reduce((a, b) => a += b);
            const changeTodayPercentage = changeToday * 100 / amount;
            const profit = data.map(i => i.profit).reduce((a, b) => a += b);
            const profitPercentage = profit * 100 / amount;

            return (
                <TableRow>
                    <TableCell colSpan={5}></TableCell>
                    <DataTableCell value={changeToday} {...fields[5]} />
                    <DataTableCell value={changeTodayPercentage} {...fields[6]} />
                    <DataTableCell value={profit} {...fields[7]} />
                    <DataTableCell value={profitPercentage} {...fields[8]} />
                </TableRow>
            );
        }

        return (
            <React.Fragment>
                <Typography variant="h5">{label} Portfolio</Typography>
                <TableContainer component={Paper} sx={{ my: "1rem" }}>
                    <Table size="small" aria-label="simple table">
                        <TableHead>
                            <TableRow>
                                { fields.map((field) => <HeaderTableCell {...field} />) }
                            </TableRow>
                        </TableHead>
                        <TableBody>
                            {data.map((row) => (
                                <TableRow key={row.symbol}>
                                    { fields.map((field) => <DataTableCell value={row[field.field]} {...field} />) }
                                </TableRow>
                            ))}
                            <SummaryRow data={data} />
                        </TableBody>
                    </Table>
                </TableContainer>
            </React.Fragment>
        );
    };

    const InstrumentPicker = ({ value, setValue }) => {
        const [options, setOptions] = React.useState([]);
        const search = debounce((event, inputValue) => {
            if (inputValue.trim().length === 0) {
                setOptions([]);
                return;
            }
            fetch(`/search?query=${inputValue.trim()}`)
                .then((response) => response.json())
                .then((response) => setOptions(response.Data));
        }, 300);

        return (
            <Autocomplete
                filterOptions={(x) => x}
                options={options}
                value={value}
                onInputChange={search}
                onChange={(event, newValue) => setValue(newValue)}
                renderInput={(params) => <TextField required {...params} name="instrument" size="small" label="Instrument" />}
                getOptionLabel={(option) => `${option.Symbol} ${option.Description}`}
            />
        );
    };

    const AddTradeForm = ({ refreshData }) => {
        const [ snackbarOpen, setSnackbarOpen ] = React.useState(false);
        const [ snackbarMsg, setSnackbarMsg ] = React.useState();
        const [ instrument, setInstrument ] = React.useState(null);
        const addTrade = (e) => {
            e.preventDefault();
            const values = Object.values(e.target)
                .filter(field => field.type === 'number')
                .reduce((obj,field) => { obj[field.name] = field.valueAsNumber; return obj }, {});
            values.instrument = instrument?.Identifier;
            values.ticker = instrument?.Symbol;

            fetch('/add-trade', {
                method: "post",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(values)
            })
            .then((response) => {
                setSnackbarMsg('Trade Added')
                setSnackbarOpen(true);
                setInstrument(null);
                e.target.reset();
                refreshData();
            });
        };
        const inputProps = { step: 'any' };
        const snackbarStyle = {
            color: 'white',
            fontWeight: 'bold',
            backgroundColor: '#4e9a51'
        };
        return (
            <form onSubmit={addTrade}>
                <Box sx={{ display: 'inline-flex', width: '30rem', maxWidth: '100%', flexDirection: "column", gap: '1rem', my: 4 }}>
                    <Typography variant="h5">Add Trade</Typography>
                    <InstrumentPicker value={instrument} setValue={setInstrument} />
                    <TextField required size="small" type="number" inputProps={inputProps} name="price" label="Price" />
                    <TextField required size="small" type="number" name="quantity" label="Quantity" />
                    <TextField required size="small" type="number" inputProps={inputProps} name="notional" label="Notional" />
                    <Button type="submit" variant="contained">Add Trade</Button>
                </Box>

                <Snackbar
                    open={snackbarOpen}
                    onClose={() => setSnackbarOpen(false)}
                    autoHideDuration={2000}
                >
                    <SnackbarContent style={snackbarStyle} message={snackbarMsg} />
                </Snackbar>
            </form>
        );
    };

    const App = () => {
        const [ usData, setUsData ] = React.useState();
        const [ sgData, setSgData ] = React.useState();

        const refreshData = () => fetch('/portfolio')
            .then((response) => {
                if (!response.ok) {
                    document.location = '/authorize';
                }
                return response.json();
            })
            .then((response) => {
                setUsData(sort(response.filter(i => !i.symbol.endsWith(':xses')), 'changeTodayPercentage'));
                setSgData(sort(response.filter(i => i.symbol.endsWith(':xses')), 'changeTodayPercentage'));
            });

        React.useEffect(refreshData, []);

        return (
            <ThemeProvider theme={darkTheme}>
                <Container>
                    <CssBaseline />
                    <Box sx={{ my: 4 }}>
                        { sgData ? <PortTable label="SG" data={sgData} setData={setSgData} /> : '' }
                        { usData ? <PortTable label="US" data={usData} setData={setUsData} /> : '' }
                    </Box>
                    <AddTradeForm refreshData={refreshData} />
                </Container>
            </ThemeProvider>
        );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
